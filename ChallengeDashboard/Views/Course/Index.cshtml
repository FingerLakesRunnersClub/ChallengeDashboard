@using System.Text.Json
@using FLRC.ChallengeDashboard
@model Course
@{ ViewBag.Title = Model.Name; }

<h2>@Model.Name</h2>
<h4>@Model.Distance (@Model.Type)</h4>

<app>
    <div v-if="!show_results" class="alert alert-danger">No results found</div>
    <table v-if="show_results" class="table table-bordered table-striped table-sm">
        <thead>
            <tr>
                <th v-for="field in fields" class="sortable" :class="{'text-center': field.center}" :style="{'flex-grow': field.width}" @@click="toggleSort(field)">
                    <span v-if="field.center" class="spacer"></span>
                    {{field.label || field.name}}
                    <div class="spacer">
                        <span v-if="sort.field == field && !sort.descending">▾</span>
                        <span v-if="sort.field == field && sort.descending">▴</span>
                    </div>
                </th>
            </tr>
        </thead>
        <tbody>
            <tr v-for="result in sorted_results">
                <td v-for="field in fields" :class="{'text-center': field.center}">
                    {{field.value(result)}}
                </td>
            </tr>
        </tbody>
    </table>
</app>

<script>
    new Vue({
        el: 'app',
        data: {
            fields: [
                { name: 'Rank', width: 1, center: true, value: r => r.Rank },
                { name: 'Name', width: 2, center: false, value: r => r.Athlete.Name },
                { name: 'Age', width: 1, center: true, value: r => r.Athlete.Age },
                { name: 'Team', width: 1, center: true, value: r => r.Athlete.Team },
                { name: 'Category', width: 1, center: true, value: r => r.Athlete.Category },
                { name: 'Time', width: 2, center: true, value: r => r.Value.DisplayTime },
                { name: 'BehindLeader', label: 'Behind', width: 2, center: true, value: r => r.BehindLeaderDisplay },
                { name: 'AgeGrade', label: 'Age Grade', width: 1, center: true, value: r => r.AgeGradeDisplay },
            ],
            sort: {
                field: null,
                descending: false
            },
            results: @Html.Raw(JsonSerializer.Serialize(Model.Fastest()))
        },
        computed: {
            show_results: function() {
                return this.results.length > 0;
            },
            sorted_results: function() {
                if (!this.sort.field)
                    this.sort.field = this.fields[0];
                const sorted = this.results.concat().sort((r1, r2) => {
                    const v1 = this.sort.field.value(r1);
                    const v2 = this.sort.field.value(r2);
                    return v1 > v2 ? 1
                        : (v1 < v2 ? -1
                        : 0);
                });
                return this.sort.descending ? sorted.reverse() : sorted;
            }
        },
        methods: {
            toggleSort: function(field, object) {
                this.sort.descending = (field === this.sort.field) ? !this.sort.descending : false;
                this.sort.field = field;
                this.sort.object = object;
            }
        }
    });
</script>